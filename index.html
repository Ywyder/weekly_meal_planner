<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Wochen-Speiseplaner</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Inter Font -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      margin: 0;
      background-image: linear-gradient(to bottom right, #1f2937, #0d3b66);
    }
  </style>
</head>
<body>
  <app-root></app-root>

  <script type="module">
    import { Component, ChangeDetectionStrategy, signal, computed, OnInit } from 'https://unpkg.com/@angular/core@17.3.0/fesm2022/core.mjs';
    import { CommonModule } from 'https://unpkg.com/@angular/common@17.3.0/fesm2022/common.mjs';
    import { FormsModule } from 'https://unpkg.com/@angular/forms@17.3.0/fesm2022/forms.mjs';
    import { bootstrapApplication } from 'https://unpkg.com/@angular/platform-browser@17.3.0/fesm2022/platform-browser.mjs';
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    setLogLevel('debug');

    @Component({
      selector: 'app-root',
      standalone: true,
      imports: [CommonModule, FormsModule],
      template: `
        <div class="p-6 min-h-screen flex flex-col items-center justify-center bg-gray-900 bg-cover bg-center" style="background-image: linear-gradient(to bottom right, #1f2937, #0d3b66);">
          <div class="w-full max-w-4xl bg-white shadow-2xl rounded-2xl p-8">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-center text-gray-900 mb-2">Wochen-Speiseplaner</h1>
            <p class="text-center text-gray-500 mb-8">Definieren Sie Mahlzeiten und erstellen Sie eine Einkaufsliste.</p>
            
            <div class="mb-4 text-center text-sm text-gray-600">
              Benutzer-ID: <span class="font-mono bg-gray-200 px-2 py-1 rounded-md">{{ userId() }}</span>
            </div>

            @if (!isAuthReady()) {
              <div class="text-center text-red-500 font-medium my-4">
                Lade...
              </div>
            } @else {
              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                @for (day of daysOfWeek; track day) {
                  <div class="mb-4 p-6 bg-gray-50 rounded-lg shadow-inner">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">{{ day }}</h2>
                    
                    <div class="mb-4">
                      <h3 class="font-semibold text-gray-700 mb-2">Abendessen</h3>
                      <input
                        type="text"
                        [(ngModel)]="mealPlan()![day]['dinner'].name"
                        (ngModelChange)="updatePlan()"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-sm mb-2"
                        placeholder="z.B. Pfannkuchen"
                      >
                      <textarea
                        [(ngModel)]="mealPlan()![day]['dinner'].ingredients"
                        (ngModelChange)="updatePlan()"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-sm"
                        placeholder="Zutaten, Komma-getrennt"
                      ></textarea>
                    </div>
                  </div>
                }
              </div>

              <div class="flex justify-center mt-8">
                <button (click)="generateShoppingList()" class="px-6 py-3 bg-indigo-600 text-white rounded-lg shadow-md hover:bg-indigo-700 transition-colors duration-200 font-medium">
                  Einkaufsliste erstellen
                </button>
              </div>

              @if (shoppingList().length > 0) {
                <div class="mt-8 p-6 bg-gray-50 rounded-lg shadow-inner">
                  <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">Ihre Einkaufsliste</h2>
                  <ul class="list-disc pl-6 text-gray-700 space-y-2">
                    @for (item of shoppingList(); track item) {
                      <li class="bg-white p-2 rounded-md shadow-sm">{{ item }}</li>
                    }
                  </ul>
                </div>
              }
            }
          </div>
        </div>
      `,
      changeDetection: ChangeDetectionStrategy.OnPush,
    })
    class App implements OnInit {
      private db: any;
      private auth: any;
      
      userId = signal<string | null>(null);
      isAuthReady = signal<boolean>(false);
      mealPlan = signal<any>(null);
      
      daysOfWeek = ['Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag', 'Sonntag'];

      shoppingList = signal<string[]>([]);

      ngOnInit() {
        this.initializeFirebase();
      }

      async initializeFirebase() {
        try {
          const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
          const app = initializeApp(firebaseConfig);
          this.db = getFirestore(app);
          this.auth = getAuth(app);
          
          onAuthStateChanged(this.auth, async (user) => {
            if (user) {
              this.userId.set(user.uid);
              await this.subscribeToMealPlan();
            } else {
              try {
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                if (initialAuthToken) {
                  await signInWithCustomToken(this.auth, initialAuthToken);
                } else {
                  await signInAnonymously(this.auth);
                }
              } catch (error) {
                console.error("Fehler bei der Anmeldung:", error);
              }
            }
            this.isAuthReady.set(true);
          });
        } catch (e) {
          console.error("Fehler beim Initialisieren von Firebase:", e);
        }
      }

      async subscribeToMealPlan() {
        const userId = this.userId();
        if (!userId) return;

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const docRef = doc(this.db, 'artifacts', appId, 'users', userId, 'data', 'meal-plan');
        
        onSnapshot(docRef, (docSnap) => {
          if (docSnap.exists()) {
            const data = docSnap.data();
            this.mealPlan.set(data);
          } else {
            const initialPlan: any = {};
            this.daysOfWeek.forEach(day => {
              initialPlan[day] = { 'dinner': { name: '', ingredients: '' } };
            });
            this.mealPlan.set(initialPlan);
            setDoc(docRef, initialPlan, { merge: true });
          }
        }, (error) => {
          console.error("Fehler beim Abonnieren des Dokuments:", error);
        });
      }

      updatePlan() {
        const userId = this.userId();
        if (!userId || !this.mealPlan()) return;

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const docRef = doc(this.db, 'artifacts', appId, 'users', userId, 'data', 'meal-plan');
        setDoc(docRef, this.mealPlan(), { merge: true }).catch(e => {
          console.error("Fehler beim Speichern:", e);
        });
      }

      generateShoppingList() {
        const allIngredients = new Set<string>();
        const plan = this.mealPlan();
        if (!plan) return;

        this.daysOfWeek.forEach(day => {
          const ingredients = plan[day]['dinner'].ingredients;
          if (ingredients) {
            ingredients.split(',').forEach((item: string) => {
              const trimmedItem = item.trim();
              if (trimmedItem) {
                allIngredients.add(trimmedItem.charAt(0).toUpperCase() + trimmedItem.slice(1));
              }
            });
          }
        });

        const sortedList = Array.from(allIngredients).sort((a, b) => a.localeCompare(b));
        this.shoppingList.set(sortedList);
      }
    }

    bootstrapApplication(App);
  </script>
</body>
</html>
